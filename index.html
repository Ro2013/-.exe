<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>蘿蔔頭聊天室</title>
</head>
<body>
  <h2>蘿蔔頭聊天室</h2>

  <div id="login">
    <input id="server" placeholder="伺服器 IP:PORT"><br>
    <input id="nickname" placeholder="暱稱"><br>
    <input id="password" placeholder="密碼"><br>
    <button onclick="register()">註冊</button>
    <button onclick="login()">登入</button>
  </div>

  <div id="chat" style="display:none">
    <p>目前用戶：<span id="current_user"></span></p>
    <select id="target_user"></select><br>
    <input id="message"><button onclick="send()">送出</button>
    <pre id="chatbox"></pre>
  </div>

  <script>
    let socket;
    let nickname;

    function register() {
      connect(() => {
        socket.send(JSON.stringify({
          action: 'register',
          nickname: document.getElementById('nickname').value,
          password: document.getElementById('password').value
        }));
      });
    }

    function login() {
      connect(() => {
        nickname = document.getElementById('nickname').value;
        socket.send(JSON.stringify({
          action: 'login',
          nickname: nickname,
          password: document.getElementById('password').value
        }));
      });
    }

    function connect(callback) {
      const server = document.getElementById('server').value.split(':');
      socket = new WebSocket(`ws://${server[0]}:${server[1]}`);
      socket.onopen = callback;

      socket.onmessage = e => {
        let data = JSON.parse(e.data);
        if (data.status === 'ok') {
          document.getElementById('login').style.display = 'none';
          document.getElementById('chat').style.display = 'block';
          document.getElementById('current_user').innerText = nickname;
          socket.send(JSON.stringify({ action: 'list' }));
        } else if (data.status === 'error') {
          alert(data.msg);
        } else if (data.users) {
          let select = document.getElementById('target_user');
          select.innerHTML = '';
          data.users.forEach(u => {
            if (u !== nickname) {
              select.innerHTML += `<option>${u}</option>`;
            }
          });
        } else if (data.msg) {
          document.getElementById('chatbox').textContent += `[${data.from}]: ${data.msg}\n`;
        }
      };
    }

    function send() {
      let msg = document.getElementById('message').value;
      let target = document.getElementById('target_user').value;
      socket.send(JSON.stringify({
        action: 'message',
        to: target,
        msg: msg
      }));
      document.getElementById('message').value = '';
    }
  </script>
</body>
</html>
