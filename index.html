<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>è˜¿è””é ­èŠå¤©å®¤</title>
</head>
<body>
  <h2>è˜¿è””é ­èŠå¤©å®¤</h2>

  <!-- ä½¿ç”¨èªªæ˜æŒ‰éˆ• -->
  <button onclick="showUsage()">ä½¿ç”¨æ–¹æ³•</button>

  <div id="login">
    <input id="nickname" placeholder="æš±ç¨±"><br>
    <input id="password" placeholder="å¯†ç¢¼" type="password"><br>
    <button onclick="register()">è¨»å†Š</button>
    <button onclick="login()">ç™»å…¥</button>
  </div>

  <div id="chat" style="display:none">
    <p>ç›®å‰ç”¨æˆ¶ï¼š<span id="current_user"></span></p>
    <select id="target_user"></select><br>
    <input id="message"><button onclick="send()">é€å‡º</button>
    <pre id="chatbox"></pre>
  </div>

  <script>
    let socket;
    let nickname;
    let retryInterval = 5000;
    let retryTimer = null;
    let pendingAction = null; // 'register' æˆ– 'login'
    let pendingCallback = null;

    function register() {
      nickname = document.getElementById('nickname').value;
      pendingAction = 'register';
      connect(() => {
        socket.send(JSON.stringify({
          action: 'register',
          nickname: nickname,
          password: document.getElementById('password').value
        }));
      });
    }

    function login() {
      nickname = document.getElementById('nickname').value;
      pendingAction = 'login';
      connect(() => {
        socket.send(JSON.stringify({
          action: 'login',
          nickname: nickname,
          password: document.getElementById('password').value
        }));
      });
    }

    function connect(callback) {
      if (socket && socket.readyState <= 1) {
        console.log("ğŸ”„ å·²æœ‰é€£ç·šæˆ–æ­£åœ¨é€£ç·šä¸­ï¼Œç•¥é");
        return;
      }

      console.log("ğŸ”Œ å˜—è©¦é€£ç·šä¸­...");
      socket = new WebSocket("wss://luo-bo-tou-liao-tian-shi-si-fu-qi.onrender.com/ws");

      socket.onopen = () => {
        console.log("âœ… WebSocket å·²é€£ç·š");
        clearInterval(retryTimer);
        retryTimer = null;
        if (callback) callback();
      };

      socket.onerror = (e) => {
        console.warn("âŒ WebSocket éŒ¯èª¤ï¼Œå°‡è‡ªå‹•é‡è©¦...", e);
      };

      socket.onclose = () => {
        console.warn("ğŸ”Œ é€£ç·šä¸­æ–·ï¼Œå°‡æ–¼ 5 ç§’å¾Œé‡è©¦...");
        if (!retryTimer) {
          retryTimer = setInterval(() => {
            if (pendingAction === 'register') {
              register();
            } else if (pendingAction === 'login') {
              login();
            }
          }, retryInterval);
        }
      };

      socket.onmessage = e => {
        let data = JSON.parse(e.data);
        if (data.status === 'ok') {
          document.getElementById('login').style.display = 'none';
          document.getElementById('chat').style.display = 'block';
          document.getElementById('current_user').innerText = nickname;
          socket.send(JSON.stringify({ action: 'list' }));
        } else if (data.status === 'error') {
          alert("â— éŒ¯èª¤ï¼š" + data.msg);
        } else if (data.users) {
          let select = document.getElementById('target_user');
          select.innerHTML = '';
          data.users.forEach(u => {
            if (u !== nickname) {
              select.innerHTML += `<option>${u}</option>`;
            }
          });
        } else if (data.msg) {
          document.getElementById('chatbox').textContent += `[${data.from}]: ${data.msg}\n`;
        }
      };
    }

    function send() {
      let msg = document.getElementById('message').value;
      let target = document.getElementById('target_user').value;
      socket.send(JSON.stringify({
        action: 'message',
        to: target,
        msg: msg
      }));
      document.getElementById('message').value = '';
    }

    function showUsage() {
      alert(`ã€ä½¿ç”¨æ–¹æ³•ã€‘
1. è¼¸å…¥ä½ çš„æš±ç¨±èˆ‡å¯†ç¢¼ã€‚
2. é»é¸ã€Œè¨»å†Šã€æˆ–ã€Œç™»å…¥ã€ã€‚
3. ç™»å…¥æˆåŠŸå¾Œï¼Œæœƒé¡¯ç¤ºèŠå¤©å®¤ä»‹é¢èˆ‡ä½¿ç”¨è€…æ¸…å–®ã€‚
4. é¸æ“‡èŠå¤©å°è±¡ï¼Œè¼¸å…¥è¨Šæ¯ä¸¦é»ã€Œé€å‡ºã€ã€‚
`);
    }
  </script>
</body>
</html>
